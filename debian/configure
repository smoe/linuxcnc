#!/bin/bash
# dpkg configuration script for linuxcnc
# Copyright (C) 2006 Jeff Epler
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# When used to produce a debian package, this file is a script "used to
# control compilation and installation of the executable"

set -e

usage () {
    P=${0##*/}
    cat <<EOF
$P: Obsolete script to set up debian/ files to build for a particular kernel

Usage:
  $P
EOF
}

cd "${0%/*}"

if [ "$1" == "-h" ] || [ "$1" == "-help" ] || [ "$1" == "--help" ]; then
    usage
    exit 0
fi

ENABLE_BUILD_DOCUMENTATION=yes

# Specialize these based on DISTRIB_NAME as needed
# These do not run-time depend on a specific package because
# the whole point is to allow a range of kernels to work, and we don't know
# of any common thing that all such kernels would provide.

while test $# -ne 0; do
    case "$1" in
    sim|uspace|noauto) echo "$1 is accepted for compatibility, but ignored";;
    help|-h|--help) usage; exit 0 ;;
    no-docs|nodocs) unset ENABLE_BUILD_DOCUMENTATION ;;
    *)  echo 1>&2 "Unknown option: $1"
        echo 1>&2
	usage
        exit 99 ;;
    esac
    shift
done

DISTRIB_NAME=
if [ "$(command -v lsb_release)" != "" ] || [ "$(which lsb_release)" != "" ]; then
    ID="$(lsb_release --short --id)"
    RELEASE="$(lsb_release --short --release)"
    # Workaround for broken lsb_release, <URL: https://bugs.debian.org/1008735 >
    case "$RELEASE" in
      n/a)
        RELEASE=unstable
        ;;
    esac
    DISTRIB_NAME="$ID-$RELEASE"
elif [ -f /etc/lsb-release ]; then
    source /etc/lsb-release
    DISTRIB_NAME=$DISTRIB_ID-$DISTRIB_RELEASE
fi

DISTRIB_NAME=uspace-$DISTRIB_NAME

if [ -z "$ENABLE_BUILD_DOCUMENTATION" ]; then
    echo "error: No need to run debian/configure any more."
    echo "To build without documentation use:"
    echo "   DEB_BUILD_OPTIONS=nodoc DEB_BUILD_PROFILES=nodoc debuild"
    exit 1
fi

rm -f ../build-stamp
echo "I: Successfully configured for '$DISTRIB_NAME'."

echo "I: You can now start the build of LinuxCNC Debian packages."
echo "   To build and test everything: fakeroot debian/rules binary"
echo "   To build the executables and man pages only: fakeroot debian/rules binary-arch"
echo "   To avoid tests: DEB_BUILD_OPTIONS=nocheck debian/rules binary"
if [ -n "$ENABLE_BUILD_DOCUMENTATION" ]; then
    echo "   To avoid documentation: DEB_BUILD_OPTIONS=nodocs fakeroot debian/rules binary"
else
    echo "   Building of documentation is disabled."
fi
echo "   The DEB_BUILD_OPTIONS environment variable also works with dpkg-buildpackage."
